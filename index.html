<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Alfred</title>

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:100,300,400">
    <script src="/res/jquery-1.12.0.min.js"></script>
    <script src="/res/moment.min.js"></script>
    <script type="text/javascript">

        var cachebust = '';
        var last_background = '';

        function update() {
            // Put the data in the places
            $.get(
                '/feed.json',
                function(data) {

                    // Reload the page if the cachebust is triggered
                    if (data['cachebust'] !== cachebust) {
                        var oldcachebust = cachebust;
                        cachebust = data['cachebust'];

                        if (oldcachebust !== '') {
                            document.location.reload();
                            return;
                        }
                    }

                    /////////////////////////////////////////////////////////////////////////////////////
                    // Update calendar
                    $('div#calendar ul').remove();

                    // First day - title "TODAY"
                    var day = $('<ul class="day1">');
                    day.append($('<li class="header"><h2>Today</h2></li>'));
                    var days = 0;

                    var lastday = moment();
                    for (var i in data['events']) {

                        var ev = data['events'][i];
                        var start = moment(ev[0]);
                        var end = moment(ev[1]);
                        var end_raw = ev[1];
                        var summary = ev[2];
                        var caltype = ev[3];

                        // If this event ended before today (we might be getting stale data), don't show
                        if (moment().format('Y-MM-DD') > end.format('Y-MM-DD')) {
                            continue;
                        }

                        // Handle multi-day events - they come through with a weird end-date that
                        // includes no time, but is the day AFTER they finish
                        if (moment().format('Y-MM-DD') == end_raw) {
                            continue;
                        }

                        // If this event starts after current day, move to next day
                        if (lastday.format('Y-MM-DD') < start.format('Y-MM-DD')) {

                            // Add last day to page
                            $('div#calendar').append(day);

                            // Increment day counter
                            days = days + 1;

                            // Create next day
                            day = $('<ul class="day'+(days + 1)+'">');
                            day.append($('<li class="header">').append($('<h2>').html(start.format('dddd, Do MMMM'))));
                            lastday = start;
                        }

                        // If we have filled 3 columns, stop
                        if (days >= 3) {
                            break;
                        }

                        // Format date
                        // If started before today
                        if (lastday.format('Y-MM-DD') > start.format('Y-MM-DD')) {
                            var evnt_date = $('<strong>').append($('<span>').text('Continues'));
                        } else {
                            var evnt_date = $('<strong>').html(start.format('h:mm')).append($('<span>').text(start.format('a')));
                        }

                        var event_desc = $('<span>').html(summary);
                        var eclass = 'cal-'+caltype;

                        // Indicate if an event has already started
                        if (moment() > start) {
                            eclass += ' past';
                        }

                        // Add event to current day
                        day.append($('<li class="'+eclass+'">').append(evnt_date).append(event_desc));
                    }

                    // Set background image
                    if (last_background != data['background']) {
                        $('body').css('background-image', 'linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(' + data['background'] + ')');
                        last_background = data['background'];
                    }
                }
            );

            // Update every 5 minutes
            setTimeout(arguments.callee, 1000 * 60 * 5);
        }

        function clock() {
            var tm = moment().format('h:mm');
            var mm = moment().format('a');
            var dt = moment().format('dddd, Do MMMM');

            $('h1.time').html(tm).append($('<span>').append(mm));
            $('h2.date').html(dt);

            // Update every 5 seconds
            setTimeout(arguments.callee, 5000);
        }

        $(function() {

            // Prevent CSS caching
            var ts = new Date().getTime().toString();
            $('head').append('<link rel="stylesheet" href="/res/style.css?'+ts+'" type="text/css" />');

            update();
            clock();
        });

    </script>

</head>
<body>

<div id="container">

<div id="now">
    <div class="datetime">
        <h1 class="time"></h1>
        <h2 class="date"></h2>
    </div>
</div>


<div id="calendar">
</div>

</div>

</body>
</html>
